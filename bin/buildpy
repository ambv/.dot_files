#!/bin/bash -ex
# cd $1
export BRANCH="/tmp/configurecache-$(git branch --show-current)"
export CC=/usr/local/opt/ccache/libexec/clang
export CFLAGS="-I$(brew --prefix readline)/include"
export LDFLAGS="-L$(brew --prefix readline)/lib"
export PKG_CONFIG_PATH="$(brew --prefix openssl@1.1)/lib/pkgconfig:$(brew --prefix tcl-tk)/lib/pkgconfig"
# export CC=/usr/bin/clang
# export CFLAGS="-fsanitize=undefined -fno-omit-frame-pointer"
# export LDFLAGS="-fsanitize=undefined -fno-omit-frame-pointer"
export CONFIGURE_FLAGS=(--enable-framework=/tmp/cpython-root-$(git branch --show-current)/Library/Frameworks "--with-tcltk-libs=$(pkg-config tk --libs)" "--with-tcltk-includes=$(pkg-config tk --cflags)")
echo ${#CONFIGURE_FLAGS[@]}
if [[ "$1" == "opt" ]]; then
    echo "optimized production build"
    CONFIGURE_FLAGS+=(--enable-optimizations --with-lto)
else
    echo "PYDEBUG build"
    CONFIGURE_FLAGS+=(--cache-file=$BRANCH --with-pydebug) # --with-undefined-behavior-sanitizer"
fi

make distclean || (./configure "${CONFIGURE_FLAGS[@]}" && make distclean)
time ./configure "${CONFIGURE_FLAGS[@]}"
# time make regen-all
time make --quiet -j10
time make --quiet install