#!/bin/bash -e
export BRANCH="/tmp/configurecache-$(git branch --show-current)"
export CC=/usr/local/opt/ccache/libexec/clang
export CFLAGS="-I$(brew --prefix readline)/include"
export LDFLAGS="-L$(brew --prefix readline)/lib"
export PKG_CONFIG_PATH="$(brew --prefix openssl@1.1)/lib/pkgconfig:$(brew --prefix tcl-tk)/lib/pkgconfig"
# export CC=/usr/bin/clang
# export CFLAGS="-fsanitize=undefined -fno-omit-frame-pointer"
# export LDFLAGS="-fsanitize=undefined -fno-omit-frame-pointer"
FRAMEWORK_INSTALL_DIR="/tmp/cpython-root-$(git branch --show-current)"
export CONFIGURE_FLAGS=(--enable-framework=$FRAMEWORK_INSTALL_DIR/Library/Frameworks "--with-tcltk-libs=$(pkg-config tk --libs)" "--with-tcltk-includes=$(pkg-config tk --cflags)")
if [[ "$1" == "opt" ]]; then
    echo "optimized production build"
    CONFIGURE_FLAGS+=(--enable-optimizations --with-lto)
else
    echo "PYDEBUG build"
    CONFIGURE_FLAGS+=(--cache-file=$BRANCH --with-pydebug) # --with-undefined-behavior-sanitizer"
fi

make distclean || (./configure "${CONFIGURE_FLAGS[@]}" && make distclean)
time ./configure "${CONFIGURE_FLAGS[@]}"
# time make regen-all
time make --quiet -j10
if [[ -d $FRAMEWORK_INSTALL_DIR ]]; then
    echo "Removing stale framework directory: $FRAMEWORK_INSTALL_DIR"
    rm -rf $FRAMEWORK_INSTALL_DIR
fi

echo
echo "NOTE: buildpy doesn't \`make install\` automatically anymore"